<!DOCTYPE html>
<!--
Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
Click nbfs://nbhost/SystemFileSystem/Templates/JSP_Servlet/Html.html to edit this template
-->
<html>
    <head>
        <title>Bucket List</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            table, th, td {
                border: 1px solid;
            }
        </style>

    </head>
    <body>

        <div><h1>Bucket List</h1></div>

        <div>
            <h3>1. Request Token</h3>
            <input type="email" id="email_input" placeholder="Enter email">
            <button onclick="requestToken()">Send Token to Email</button>
        </div>
        <div>
            <h3>2. Authentication</h3>
            <input type="text" id="token_input" placeholder="Enter token">
            <button onclick="login()">Login</button>
        </div>
        <div id="auth_message"></div>
<hr>
        <div>
            <table id="objectsTable">
            </table>
        </div>
        <div>
            <img src="" id="download_image">
        </div>
<br>
        <div>
            <button onclick="fetchListOfObjects()">List Photos</button>
            <br><br>
            <label>File:</label> <input type="file" id="file_input"><br><br>
            <label>Description:</label> <input type="text" id="desc_input" placeholder="Enter description">
            <button onclick="uploadObject()">Upload</button>
        </div>


        <script>
            let isAuthorized = false;
            const UPLOAD_LAMBDA_URL = "https://nepnxwkg3gxlper6w6xvfbmx7i0bdkic.lambda-url.ap-southeast-1.on.aws/";
            const INVOKE_TOKEN_LAMBDA = "https://hf34hlx37kbor2fcb2noitptem0rvryg.lambda-url.ap-southeast-1.on.aws/";
            const DELETE_LAMBDA_URL = "https://c75kha5pjsoexqxkxum4g4inhy0vgvep.lambda-url.ap-southeast-1.on.aws/";
            const LIST_LAMBDA_URL = "https://fll7uqovpnoqjwuhy246t4a36y0xmtvn.lambda-url.ap-southeast-1.on.aws/";

            function bytesToBase64(bytes) {
                let binary = "";
                for (let i = 0; i < bytes.length; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return btoa(binary);
            }
            //getObjectList();
            fetchListOfObjects();


            // ====== 4. LIST & RENDER ======
            function fetchListOfObjects() {
                if (!isAuthorized) {
                    alert("Please login first!");
                    return;
                }

                fetch(LIST_LAMBDA_URL)
                    .then(res => res.json())
                    .then(data => {
                        console.log("Raw Data received:", data);

                        // --- THE FIX ---
                        // If data has a 'body' property, parse it. Otherwise, use data as is.
                        let actualArray = [];
                        if (Array.isArray(data)) {
                            actualArray = data;
                        } else if (data.body) {
                            actualArray = JSON.parse(data.body);
                        }

                        if (Array.isArray(actualArray)) {
                            document.getElementById("objectsTable").style.display = "table";
                            renderTable(actualArray);
                        } else {
                            console.error("Data is still not an array:", actualArray);
                        }
                    })
                    .catch(err => console.error("Fetch Error:", err));
}

        function renderTable(data) {
    let table = document.getElementById("objectsTable");
    table.innerHTML = `<tr><th>Thumb</th><th>S3 Key</th><th>Description</th><th>Uploader</th><th>Actions</th></tr>`;
    
    // Convert to lowercase for safer comparison
    const currentEmail = document.getElementById("email_input").value.trim().toLowerCase();

    data.forEach(obj => {
        let row = table.insertRow();
        let thumbCell = row.insertCell(0);
        let img = document.createElement("img");
        img.className = "thumb";
        img.style.width = "50px"; // Ensure thumbnails aren't huge
        
        if (obj.thumbnailData) {
            img.src = `data:image/${obj.extension || 'jpeg'};base64,${obj.thumbnailData}`;
        }
        thumbCell.appendChild(img);

        let s3Key = obj.S3Key || obj.key;
        let uploaderEmail = obj.Email || "Public";

        row.insertCell(1).innerText = s3Key;
        row.insertCell(2).innerText = obj.Description || "No description";
        row.insertCell(3).innerText = uploaderEmail;

        let actionCell = row.insertCell(4);
        
        // Download Button
        let dlBtn = document.createElement("button");
        dlBtn.innerText = "Download";
        dlBtn.onclick = () => fetchObject(s3Key);
        actionCell.appendChild(dlBtn);

        // Delete Button
        let delBtn = document.createElement("button");
        delBtn.innerText = "Delete";
        delBtn.style = "background-color:red; color:white; margin-left:5px;";
        
        delBtn.onclick = () => {
    // 1. Get the LATEST email currently in the input box when clicked
    const activeEmail = document.getElementById("email_input").value.trim().toLowerCase();
    
    // 2. Clean the uploader email from the data row
    const photoOwner = uploaderEmail.trim().toLowerCase();

    console.log("Checking permission:", activeEmail, "vs", photoOwner);

    if (activeEmail === photoOwner) {
        if (confirm(`Are you sure you want to delete ${s3Key}?`)) {
            deleteObject(s3Key, uploaderEmail);
        }
    } else {
        alert(`Permission Denied: You are logged in as ${activeEmail}, but this photo belongs to ${uploaderEmail}`);
    }
        };
        actionCell.appendChild(delBtn);
    });
}

        function deleteObject(key, ownerEmail) {
        if (!isAuthorized) {
            alert("Please login first.");
            return;
        }

        const currentLoggedInEmail = document.getElementById("email_input").value.trim();

        // This payload is sent to the Orchestrator
        const payload = { 
            key: key, 
            email: currentLoggedInEmail 
        };

        fetch(DELETE_LAMBDA_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            // The Orchestrator returns a body string that needs parsing
            const responseBody = JSON.parse(data.body);
            if (data.statusCode === 200) {
                alert("Success: " + responseBody.message);
                fetchListOfObjects(); 
            } else {
                alert("Error: " + responseBody.message);
            }
        })
        .catch(err => {
            console.error("Delete Error:", err);
            alert("Connection error occurred.");
        });
    }



            function fetchObject(key) {
                const body = {
                    "key": key
                };
                /*
                 let url = "https://c2by4ajeblmkwtz364qoludmnu0bgoge.lambda-url.ap-southeast-1.on.aws/?key=" + key;
                 */
                let url = "https://qqliajxjswpq372vebjkrwpmce0mkksf.lambda-url.ap-southeast-1.on.aws/";

                fetch(url,
                        {
                            method: 'PUT',
                            body: JSON.stringify(body)
                        }
                        )
                        .then(response => response.blob())
                        .then((myBlob) => {
                            const objectURL = URL.createObjectURL(myBlob);
                            const img_S3 = document.getElementById("download_image");
                            img_S3.src = objectURL;
                        });
            }


            /* DOWNLOAD OBJECT */
            function downloadObject(key) {
                const xhr = new XMLHttpRequest();
                xhr.onload = function () {
                    let reader = new FileReader();
                    reader.onloadend = function () {
                        if (xhr.status === 200) {
                            var outputImg = document.getElementById('download_image');
                            outputImg.src = reader.result;
                        } else {
                            console.log(xhr.status + " : " + xhr.responseText);
                        }
                    };
                    reader.readAsDataURL(xhr.response);
                };
                xhr.open("PUT", "https://qqliajxjswpq372vebjkrwpmce0mkksf.lambda-url.ap-southeast-1.on.aws//");
                const body1 = JSON.stringify({
                    "key": key
                });
                xhr.responseType = 'blob';
                xhr.send(body1);
            }

            function putObject(json) {
            //  let url = "https://y5xci32gx3rhg5ntvxtqbnw7lq0pmspe.lambda-url.ap-southeast-1.on.aws/";
            // let url = "https://nepnxwkg3gxlper6w6xvfbmx7i0bdkic.lambda-url.ap-southeast-1.on.aws/"
            fetch(UPLOAD_LAMBDA_URL, {
                    method: 'POST',
                    body: JSON.stringify(json)
                })
                .then((resp) => resp.text())
                .then(function(response) {
                    fetchListOfObjects();
                    console.info('fetch()', response);
            });
            };


            function uploadObject() {
                if (!isAuthorized) {
                    alert("Access Denied: Please login with your email and token first.");
                    return;
                }
                const fileInput = document.getElementById("file_input");
                const file = fileInput.files[0];

                if (!file) {
                    alert("Please select a file.");
                    return;
                }

                // Capture filename here
                const fileName = file.name; 
                const description = document.getElementById("desc_input").value;
                const email = document.getElementById("email_input").value;

                const reader = new FileReader();
                reader.onload = () => {
                    const body = {
                        action: "upload",
                        key: fileName, // Use the captured fileName variable
                        description: description,
                        email: email,
                        content: bytesToBase64(new Uint8Array(reader.result))
                    };
                    putObject(body);
                };
                reader.readAsArrayBuffer(file);
            }
            function deleteObject(key) {

            if (!isAuthorized) {
                alert("Access Denied: Please login with your email and token first.");
                return;
            }
            const email = document.getElementById("email_input").value;

            const body = {
                "key": key,
                "email": email
            };

            fetch(DELETE_LAMBDA_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "DELETE", key: key, email: email })
            })
                .then(res => res.json())
                .then(data => {
                    // Lambda-style response
                    if (data.statusCode && data.statusCode !== 200) {
                        const body = JSON.parse(data.body);
                        alert(body.message || "Delete failed");
                        return;
                    }

                    // Orchestrator-style success
                    alert("Deleted successfully");
                    fetchListOfObjects();
                })
                .catch(err => {
                    console.error(err);
                    alert("Unexpected error");
                });

        }

            function requestToken(){
                const email = document.getElementById("email_input").value;
                if (!email) { alert("Please fill out your email."); return; }
                //xiu nho thay cai AUTH_URL bang link
                fetch(INVOKE_TOKEN_LAMBDA, {
                    method: "POST",
                    body: JSON.stringify({ action: "generate", email: email })
                })
                .then(res => res.json())
                .then(data => {
                    const token = data.auth_status;
                    console.log("Generated Token:", token);

                    // AUTO-COPY LOGIC 
                    if (navigator.clipboard && window.isSecureContext) {
                        // Modern way (requires HTTPS or localhost)
                        navigator.clipboard.writeText(token).then(() => {
                            alert("Success! Your Security Token has been COPIED to your clipboard:\n\n" + token);
                        }).catch(err => {
                            console.error("Clipboard copy failed:", err);
                            fallbackCopy(token);
                        });
                    } else {
                        // Fallback for non-HTTPS or incompatible browsers
                        fallbackCopy(token);
                    }

                    // Update the UI message
                    document.getElementById("auth_message").style.color = "blue";
                    document.getElementById("auth_message").innerText = "Token generated successfully.";
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("An error occurred while generating the token.");
                });
            }

            function login() {
            const email = document.getElementById("email_input").value;
            const token = document.getElementById("token_input").value;

            //xiu nua lay link roi doi link
            fetch(INVOKE_TOKEN_LAMBDA, {
                method: "POST",
                body: JSON.stringify({ action: "verify", email: email, token: token })
            })
            .then(res => res.json())
            .then(data => {
                if (data.auth_status === "true" || data.auth_status === true) {
                    isAuthorized = true;
                    document.getElementById("auth_message").style.color = "green";
                    document.getElementById("auth_message").innerText = "Authorized Successfully!";
                } else {
                    alert("Unauthorized: Invalid Token.");
                }
            });
        }

        </script>
    </body>

</html>